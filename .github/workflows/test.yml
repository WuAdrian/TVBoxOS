name: Android CI - Build APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    env:
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            .gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: Setup Android SDK and JDK
        uses: android-actions/setup-android@v3.0.0
        with:
          android-sdk-version: '34'
          build-tools-version: '34.0.0'
          java-version: '11'

      - name: Accept Android SDK licenses
        run: |
          yes | sdkmanager --licenses || true

      - name: Ensure gradlew is executable
        run: chmod +x ./gradlew

      - name: Build Debug APK
        run: ./gradlew clean assembleDebug -p app

      - name: Build Release APK (if keystore provided)
        if: ${{ secrets.ANDROID_KEYSTORE != '' }}
        env:
          RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "Decoding keystore"
          # write keystore
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 --decode > app/TVBoxOSC.jks

          # inject signingConfigs into app/build.gradle (if not present)
          signingConfigs='ICAgIHNpZ25pbmdDb25maWdzIHtcCiAgICAgICAgaWYgKHByb2plY3QuaGFzUHJvcGVydHkoIlJFTEVBU0VfU1RPUkVfRklMRSIpKSB7XAogICAgICAgICAgICBteUNvbmZpZyB7XAogICAgICAgICAgICAgICAgc3RvcmVGaWxlIGZpbGUoUkVMRUFTRV9TVE9SRV9GSUxFKVwKICAgICAgICAgICAgICAgIHN0b3JlUGFzc3dvcmQgUkVMRUFTRV9TVE9SRV9QQVNTV09SRFwKICAgICAgICAgICAgICAgIGtleUFsaWFzIFJFTEVBU0VfS0VZX0FMSUFTXAogICAgICAgICAgICAgICAga2V5UGFzc3dvcmQgUkVMRUFTRV9LRVlfUEFTU1dPUkRcCiAgICAgICAgICAgICAgICB2MVNpZ25pbmdFbmFibGVkIHRydWVcCiAgICAgICAgICAgICAgICB2MlNpZ25pbmdFbmFibGVkIHRydWVcCiAgICAgICAgICAgICAgICBlbmFibGVWM1NpZ25pbmcgPSB0cnVlXAogICAgICAgICAgICAgICAgZW5hYmxlVjRTaWduaW5nID0gdHJ1ZVwKICAgICAgICAgICAgfVwKICAgICAgICB9XAogICAgfVwKXA=='
          signingConfig='ICAgICAgICAgICAgaWYgKHByb2plY3QuaGFzUHJvcGVydHkoIlJFTEVBU0VfU1RPUkVfRklMRSIpKSB7XAogICAgICAgICAgICAgICAgc2lnbmluZ0NvbmZpZyBzaWduaW5nQ29uZmlncy5teUNvbmZpZ1wKICAgICAgICAgICAgfVwK'
          signingConfigs="$(echo "$signingConfigs" | base64 -d )"
          signingConfig="$(echo "$signingConfig" | base64 -d )"
          if ! grep -q "RELEASE_STORE_FILE" ./gradle.properties; then
            sed -i -e "/defaultConfig {/i\\$signingConfigs " -e "/debug {/a\\$signingConfig " -e "/release {/a\\$signingConfig " app/build.gradle
          fi

          # write gradle properties for signing
          echo "RELEASE_STORE_FILE=./TVBoxOSC.jks" >> ./gradle.properties
          echo "RELEASE_KEY_ALIAS=${RELEASE_KEY_ALIAS:-TVBoxOSC}" >> ./gradle.properties
          echo "RELEASE_STORE_PASSWORD=${RELEASE_STORE_PASSWORD:-TVBoxOSC}" >> ./gradle.properties
          echo "RELEASE_KEY_PASSWORD=${RELEASE_KEY_PASSWORD:-TVBoxOSC}" >> ./gradle.properties

          chmod +x gradlew
          ./gradlew assembleRelease -p app --stacktrace --info

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-apks
          path: |
            app/build/outputs/apk/**/*.apk
